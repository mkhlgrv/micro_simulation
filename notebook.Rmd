---
title: "Микросимуляция"
author: Finn the Human
output: html_notebook
---

# Введение 
В курсе микроэкономики вы уже познакомились с базовой теорией производителя. Сегодня мы вспомним эту теорию и с её помощью займёмся симуляцией рыночного равновесия, а ещё посмотрим, как пользоваться R Notebook и некоторыми пакетами в R. 

Писать мы будем в простом языке разметки markdown, который интегририрован в R и легко компилируется в html (и чуть сложнее --- в pdf). Перейдём к следующему разделу и, чтобы выделить заголовок, поставим знак \# (количество \# соответствует уровню заголовка).

# Теория + LaTeX
Микроэкономическая теория предполагает, что фирма максимизирует свою прибыль, при этом она сталкивается с ограничениями. Ограничений несколько, поэтому мы будем использовать для их перечисления нумерованный список.

1. Производственная функция, которая показывает максимальное количество выпуска, которая фирма может произвести в зависимости от количества используемых факторов производства. Вставим уравнение, для этого воспользуемся синтаксисом LaTeX'а: 
  $$ y = f(x), $$
  где: 
  * $y$ --- это выпуск фирмы,
  * $x$ --- фактор производства.
  Стандартная функция $f$ имеет положительную первую производную $f'>0$ и отрицательную вторую производную $f^{(2)}>0$.


2. Цена на продукцию фирмы. В базовой модели фирма вопринимает цену как заданную (она является price-taker'ом).

Запишем функцию прибыли --- разницу между выручкой и издержками.:
$$ \pi = p \cdot y - w \cdot x,$$
где: 
  * $\pi$ --- это прибыль,
  * $p$ --- цена продукции,
  * $w$ --- цена фактора производства.
  
Решая задачу минимизации издержек при любом заданном выпуске, мы получаем функцию издержек $TC(y)$.

Можно записать прибыль в следующем виде:
$$ \pi = p \cdot y - TC(y)$$
Издержки можно разложить на постоянные $FC$ (не зависят от объема выпуска) и переменные $VC$ (зависят от объёма выпуска): 

$$TC(y) = FC + VC(y) $$. 

Поделим последнее равенство на $y$ и получим разложение средних издержек $AC$ на средние постоянные $AFC$ и средние переменные издержки $AVC$. 
Микроэкономическая теория предполагает, что фирме имеет смысл существовать в краткрочном периоде, если выручка покрывает хотя бы переменные издержки (т.е. $p \cdot y \geq VC \Leftrightarrow  p \geq AVC $), а в долгосрочном периоде (т.е., когда все издержки переменные) --- только если прибыль неотрицательна: $p \cdot y \geq TC \Leftrightarrow p \geq AC$.

Тогда, решая задачу максимизации прибыли фирмы (возьмём производную по $y$), получим в краткосрочном периоде:
$$
MC = p ,\text{если } p \geq AVC,   
$$ 
а в долгосрочном периоде:
$$
MC = p,\text{если } p \geq AC.   
$$ 

## Симуляция

Вспомнили теорию --- реализуем её в R. Симулируем рынок мёда и попробуем спрогнозировать параметры равновесия на рынке:
* объём производства $q$,
* количество фирм $n$.
В качестве бонуса посмотрим, что произойдёт, если появится налог на продажу мёда.


Чтобы сделать хороший прогноз, было бы неплохо владеть аппаратом матстатистики, но есть и более простой способ  --- надо тупо прогнать одну и ту же модель, случайным образом меняя параметры, много-много раз и посмотреть, что получится. Это называется метод Монте-Карло.

Пусть известно, что цена на мёд задана заранее как $a$, но может меняться из-за присутствия в ней **шока спроса** случайной величины $\varepsilon$ (об этом позже):

$$
p = a + \varepsilon.
$$

Пусть на рынке может быть максимально $N$ фирм. Функция предельных издержек $MC_i$ для каждой фирмы $i, i  = \overline{1,N}$ имеет следующий вид:
$$
MC_i = c + d*q_i + v_i
$$
где:
* $с, d$ --- заранее заданные, общие для каждой из фирм параметры, 
* $q_i$ --- объём производства фирмы $i$
* $v_i$ --- **шок предложения** для фирмы $i$, случайная величина.

### Случайные величины
Мы ввели величины $v_i$ и $\varepsilon$ --- случайные ошибки --- для отражения всех факторов, которые влияют на спрос и предложение и которые мы не стали учитывать в модели (и не смогли бы!). Разумно выбрать эти величины **нормально распределёнными**. Не будем углубляться в теорию, просто посмотрим, как выглядит нормальное распределение:
```{r}
set.seed(1) # правило хорошего тона: установить seed при работе со случайными величинами
library(dplyr)
library(ggplot2) # графика
library(latex2exp)
x <- seq(-3,3,0.1)
df_0_1 <- data.frame(x = x, y = dnorm(x, mean =0, sd = 1), type = 1)
df_0_0.5 <- data.frame(x = x, y = dnorm(x, mean = 0, sd = 0.5), type = 2)
df_1_1 <- data.frame(x = x, y = dnorm(x, mean = 1, sd = 1), type = 3)
df <- bind_rows(df_0_1, df_0_0.5, df_1_1)
df$type <- as.factor(df$type)
ggplot(data = df, aes(x = x, y = y, group = type, colour = type)) +
  geom_line() +
  xlim(-3,3) +
  ggtitle(data.frame(x = x, y = dnorm(x)))+
  xlab("x") +
  ylab("y") +
  scale_colour_discrete(name = "Типы",
                   labels = c(TeX("$ \\mu = 0,  \\sigma = 1$"),
                              TeX("$ \\mu = 0, \\sigma = 0.5$"),
                              TeX("$ \\mu = 0, \\sigma = 1$")))

```
С высоким шансом случайная величина принимает значения, близкие к центру, и наоборот. Нормальное распределение зависит от двух параметров --- **матожидания** $\mu$ (отвечает за смещение по оси x) и стандартного отклонения $\sigma$ (отвечает за разброс --- чем меньше, тем более сжат график).

# Сама симуляция

Мы проведём $k = 500$ симуляций для базовых значений параметров.
```{r}
set.seed(1)
k <- 500
N <- 50
a <- 20
c <- 5
d <- 1
sigma_eps <- 1
sigma_v <- 0.5
df <- data.frame(epsilon =
                   rnorm(k,0, sigma_eps))
for(j in 1:N){
    df <- cbind(df,rnorm(k,0, sigma_v))
}

for(i in 1:k){
  e_i <- df[i,1]
  v_i <- sort(df[i,-1])
  while()
}
```

